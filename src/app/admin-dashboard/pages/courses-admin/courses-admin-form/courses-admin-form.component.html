<div class="courses-admin-form">
  <!-- Header -->
  <div class="form-header">
    <div class="header-content">
      <h2>{{ isEdit ? 'تعديل الكورس' : 'إنشاء كورس جديد' }}</h2>
      <p class="header-description">
        قم بإنشاء كورس تعليمي متكامل مع المواد والوحدات والدروس
      </p>
    </div>
    
    <!-- Progress Bar -->
    <div class="progress-section">
      <div class="progress-bar">
        <div 
          class="progress-fill" 
          [style.width.%]="progressPercentage"
        ></div>
      </div>
      <span class="progress-text">{{ progressPercentage.toFixed(0) }}% مكتمل</span>
    </div>
  </div>

  <!-- Steps Navigation -->
  <div class="steps-nav">
    <div 
      *ngFor="let step of formState.steps" 
      class="step-item"
      [class.active]="formState.currentStep === step.id"
      [class.completed]="step.isCompleted"
      [class.error]="step.hasErrors"
      (click)="goToStep(step.id)"
    >
      <div class="step-number">
        <i class="pi pi-check" *ngIf="step.isCompleted"></i>
        <i class="pi pi-exclamation" *ngIf="step.hasErrors && !step.isCompleted"></i>
        <span *ngIf="!step.isCompleted && !step.hasErrors">{{ step.id }}</span>
      </div>
      <div class="step-content">
        <div class="step-title">{{ step.title }}</div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>جاري تحميل بيانات الكورس...</p>
  </div>

  <!-- Form Content -->
  <div class="form-content" *ngIf="!isLoading">
    
    <!-- Step 1: Subject Information -->
    <div *ngIf="formState.currentStep === 1" class="step-content">
      <app-subject-section
        [subjectData]="courseData.subject"
        [isEdit]="isEdit"
        (subjectUpdated)="onSubjectUpdated($event)"
      ></app-subject-section>
    </div>

    <!-- Step 2: Units and Lessons -->
    <div *ngIf="formState.currentStep === 2" class="step-content">

      <!-- Academic Year Selection -->
      <div class="academic-selection" *ngIf="academicYears.length > 0">
        <div class="academic-header">
          <h4>إعدادات السنة الدراسية</h4>
          <p>اختر السنة الدراسية وصف الطلاب لربط الدروس بها</p>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label class="form-label">السنة الدراسية <span class="required">*</span></label>
              <select 
                class="form-select"
                [value]="selectedAcademicYear?.id || ''"
                (change)="onAcademicYearChanged($event)"
              >
                <option value="">اختر السنة الدراسية</option>
                <option *ngFor="let year of academicYears" [value]="year.id">
                  {{ year.name }}
                </option>
              </select>
            </div>
          </div>
          <div class="col-md-6" *ngIf="selectedAcademicYear">
            <div class="form-group">
              <label class="form-label">صف الطلاب <span class="required">*</span></label>
              <select 
                class="form-select"
                [value]="selectedStudentYear?.id || ''"
                (change)="onStudentYearChanged($event)"
              >
                <option value="">اختر صف الطلاب</option>
                <option *ngFor="let studentYear of studentYears" [value]="studentYear.id">
                  {{ studentYear.name }}
                </option>
              </select>
            </div>
          </div>
        </div>
      </div>
   

      <app-units-section
        [units]="courseData.units"
        [subjectData]="courseData.subject"
        [academicYearId]="selectedAcademicYear?.id || ''"
        [studentYearId]="selectedStudentYear?.id ?? ''"
        (unitsUpdated)="onUnitsUpdated($event)"
      ></app-units-section>
    </div>

    <!-- Step 3: Review and Publish -->
    <div *ngIf="formState.currentStep === 3" class="step-content">
      <div class="review-section">
        <h3>مراجعة الكورس</h3>
        
        <!-- Subject Summary -->
        <div class="review-card">
          <h4>معلومات المادة</h4>
          <div class="summary-grid">
            <div class="summary-item">
              <label>اسم المادة:</label>
              <span>{{ courseData.subject.name }}</span>
            </div>
            <div class="summary-item">
              <label>المستوى:</label>
              <span>{{ courseData.subject.difficulty }}</span>
            </div>
            <div class="summary-item">
              <label>المدة:</label>
              <span>{{ courseData.subject.duration }}</span>
            </div>
            <div class="summary-item">
              <label>الترتيب:</label>
              <span>{{ courseData.subject.order }}</span>
            </div>
          </div>
          <div class="summary-description">
            <label>الوصف:</label>
            <p>{{ courseData.subject.description }}</p>
          </div>
        </div>

        <!-- Units and Lessons Summary -->
        <div class="review-card">
          <h4>الوحدات والدروس</h4>
          <div class="stats-grid">
            <div class="stat-item">
              <i class="pi pi-bookmark-fill"></i>
              <span class="stat-number">{{ courseData.units.length }}</span>
              <span class="stat-label">وحدة</span>
            </div>
            <div class="stat-item">
              <i class="pi pi-play-circle"></i>
              <span class="stat-number">{{ courseData.totalLessons }}</span>
              <span class="stat-label">درس</span>
            </div>
            <div class="stat-item">
              <i class="pi pi-clock"></i>
              <span class="stat-number">{{ formatDuration(courseData.totalDuration) }}</span>
              <span class="stat-label">إجمالي المدة</span>
            </div>
          </div>

          <!-- Units List -->
          <div class="units-review">
            <div *ngFor="let unit of courseData.units; let i = index" class="unit-review">
              <h5>{{ i + 1 }}. {{ unit.name }}</h5>
              <p>{{ unit.description }}</p>
              <div class="lessons-count">
                <i class="pi pi-video"></i>
                {{ unit.lessons?.length || 0 }} دروس
              </div>
              
              <!-- Lessons preview -->
              <div class="lessons-preview" *ngIf="unit.lessons && unit.lessons.length > 0">
                <div *ngFor="let lesson of unit.lessons" class="lesson-preview">
                  <i class="pi pi-play"></i>
                  <span>{{ lesson.title }}</span>
                  <span class="lesson-duration">({{ formatDuration(lesson.duration) }})</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Messages -->
  <div class="messages-container">
    <div *ngIf="errorMsg" class="alert alert-danger">
      <i class="pi pi-exclamation-circle"></i>
      {{ errorMsg }}
    </div>
    <div *ngIf="successMsg" class="alert alert-success">
      <i class="pi pi-check-circle"></i>
      {{ successMsg }}
    </div>
  </div>

  <!-- Navigation Buttons -->
  <div class="form-actions">
    <div class="actions-left">
      <button 
        type="button" 
        class="btn btn-outline-secondary"
        (click)="cancel()"
        [disabled]="isSaving"
      >
        <i class="pi pi-times"></i>
        إلغاء
      </button>
    </div>

    <div class="actions-center">
      <button 
        type="button" 
        class="btn btn-outline-primary"
        (click)="previousStep()"
        [disabled]="isFirstStep || isSaving"
        *ngIf="!isFirstStep"
      >
        <i class="pi pi-arrow-right"></i>
        السابق
      </button>

      <button 
        type="button" 
        class="btn btn-primary"
        (click)="nextStep()"
        [disabled]="!canGoNext || isSaving"
        *ngIf="!isLastStep"
      >
        التالي
        <i class="pi pi-arrow-left"></i>
      </button>
    </div>

    <div class="actions-right">
      <button 
        type="button" 
        class="btn btn-outline-info"
        (click)="saveCourse()"
        [disabled]="!formState.isValid || isSaving"
        *ngIf="isLastStep"
      >
        <i class="pi pi-save" *ngIf="!isSaving"></i>
        <i class="pi pi-spinner pi-spin" *ngIf="isSaving"></i>
        {{ isSaving ? 'جاري الحفظ...' : 'حفظ كمسودة' }}
      </button>

      <button 
        type="button" 
        class="btn btn-success"
        (click)="publishCourse()"
        [disabled]="!formState.isValid || isSaving"
        *ngIf="isLastStep"
      >
        <i class="pi pi-globe" *ngIf="!isSaving"></i>
        <i class="pi pi-spinner pi-spin" *ngIf="isSaving"></i>
        {{ isSaving ? 'جاري النشر...' : 'نشر الكورس' }}
      </button>
    </div>
  </div>
</div>