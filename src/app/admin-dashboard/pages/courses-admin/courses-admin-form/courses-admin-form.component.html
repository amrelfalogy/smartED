<div class="courses-admin-form">
  <div class="form-header">
    <div class="header-content">
      <h2>{{ isEdit ? 'تعديل الكورس' : 'إنشاء كورس جديد' }}</h2>
      <p class="header-description">
        قم بإنشاء كورس تعليمي متكامل مع المواد والوحدات والدروس
      </p>
    </div>

    <div class="progress-section">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="progressPercentage"></div>
      </div>
      <span class="progress-text">{{ progressPercentage.toFixed(0) }}% مكتمل</span>
    </div>
  </div>

  <div class="steps-nav">
    <div
      *ngFor="let step of formState.steps"
      class="step-item"
      [class.active]="formState.currentStep === step.id"
      [class.completed]="step.isCompleted"
      [class.error]="step.hasErrors"
      (click)="goToStep(step.id)"
    >
      <div class="step-number">
        <i class="pi pi-check" *ngIf="step.isCompleted"></i>
        <i class="pi pi-exclamation" *ngIf="step.hasErrors && !step.isCompleted"></i>
        <span *ngIf="!step.isCompleted && !step.hasErrors">{{ step.id }}</span>
      </div>
      <div class="step-content">
        <div class="step-title">{{ step.title }}</div>
      </div>
    </div>
  </div>

  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>جاري تحميل بيانات الكورس...</p>
  </div>

  <div class="form-content" *ngIf="!isLoading">
    <!-- Step 1 -->
    <div *ngIf="formState.currentStep === 1" class="step-content">
      <div class="academic-selection">
        <div *ngIf="isLoadingAcademicData" class="academic-loading">
          <div class="loading-container">
            <div class="spinner"></div>
            <p>جاري تحميل البيانات الأكاديمية...</p>
          </div>
        </div>

        <div *ngIf="!isLoadingAcademicData && academicDataLoaded" class="academic-content">
          <div *ngIf="academicYears.length > 0" class="academic-form">
            <div class="academic-header">
              <h4>إعدادات السنة الدراسية</h4>
              <p>اختر السنة الدراسية وصف الطلاب لربط المادة بها</p>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">السنة الدراسية <span class="required">*</span></label>
                  <select
                    class="form-select"
                    [(ngModel)]="selectedAcademicYearId"
                    (ngModelChange)="onAcademicYearIdChange($event)"
                    [disabled]="isLoadingStudentYears"
                  >
                    <option value="">اختر السنة الدراسية</option>
                    <option *ngFor="let ay of academicYears" [value]="ay.id">{{ ay.name }}</option>
                  </select>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">صف الطلاب <span class="required">*</span></label>
                  <div *ngIf="isLoadingStudentYears" class="student-year-loading">
                    <div class="form-select disabled">
                      <i class="pi pi-spinner pi-spin me-2"></i>
                      جاري التحميل...
                    </div>
                  </div>
                  <select
                    *ngIf="!isLoadingStudentYears"
                    class="form-select"
                    [(ngModel)]="selectedStudentYearId"
                    (ngModelChange)="onStudentYearIdChange($event)"
                    [disabled]="!selectedAcademicYearId"
                  >
                    <option value="">
                      {{ selectedAcademicYearId ? 'اختر صف الطلاب' : 'اختر السنة الدراسية أولاً' }}
                    </option>
                    <option *ngFor="let sy of studentYears" [value]="sy.id">{{ sy.name }}</option>
                  </select>
                </div>
              </div>
            </div>

            <div *ngIf="selectedAcademicYear && selectedStudentYear" class="selection-summary">
              <div class="alert alert-info">
                <i class="pi pi-info-circle me-2"></i>
                <strong>الاختيار الحالي:</strong>
                {{ selectedAcademicYear.name }} - {{ selectedStudentYear.name }}
              </div>
            </div>
          </div>

          <div *ngIf="academicYears.length === 0" class="no-academic-data">
            <div class="alert alert-warning">
              <i class="pi pi-exclamation-triangle me-2"></i>
              <strong>تنبيه:</strong> لا توجد سنوات دراسية متاحة حالياً.
            </div>
          </div>
        </div>
      </div>

      <app-subject-section
        *ngIf="!isLoadingAcademicData && academicDataLoaded"
        [subjectData]="courseData.subject"
        [isEdit]="isEdit"
        [selectedAcademicYearId]="selectedAcademicYearId || null"
        [selectedStudentYearId]="selectedStudentYearId || null"
        [currentUserId]="currentUserId"
        [currentUserRole]="currentUserRole" 
        (subjectUpdated)="onSubjectUpdated($event)"
      ></app-subject-section>
    </div>

    <!-- Step 2 -->
    <div *ngIf="formState.currentStep === 2" class="step-content">
      <app-units-section
        [units]="courseData.units"
        [subjectData]="courseData.subject"
        (unitsUpdated)="onUnitsUpdated($event)"
      ></app-units-section>
    </div>

    <!-- Step 3 -->
    <div *ngIf="formState.currentStep === 3" class="step-content">
      <div class="review-section">
        <h3>مراجعة الكورس</h3>

        <div class="review-card">
          <h4>معلومات المادة</h4>
          <div class="summary-grid">
            <div class="summary-item"><label>الاسم:</label><span>{{ courseData.subject.name }}</span></div>                        
            <div class="summary-item"><label>نوع التقديم:</label><span>{{ courseData.subject.sessionType || 'غير محدد' }}</span></div>
            <div class="summary-item"><label>السعر:</label><span>{{ courseData.subject.price || 0 }} جنيه</span></div>
            <div class="summary-item"><label>الحالة:</label><span>{{ courseData.subject.status || 'draft' }}</span></div>
            <div class="summary-item"><label>الترتيب:</label><span>{{ courseData.subject.order }}</span></div>
          </div>
          <div class="summary-description">
            <label>الوصف:</label>
            <p>{{ courseData.subject.description }}</p>
          </div>
        </div>

        <div class="review-card">
          <h4>الوحدات والدروس</h4>
            <div class="stats-grid">
              <div class="stat-item">
                <i class="pi pi-bookmark-fill"></i>
                <span class="stat-number">{{ courseData.units.length }}</span>
                <span class="stat-label">وحدة</span>
              </div>
              <div class="stat-item">
                <i class="pi pi-play-circle"></i>
                <span class="stat-number">{{ courseData.totalLessons }}</span>
                <span class="stat-label">درس</span>
              </div>
              <div class="stat-item">
                <i class="pi pi-clock"></i>
                <span class="stat-number">{{ formatDuration(courseData.totalDuration) }}</span>
                <span class="stat-label">المدة الإجمالية</span>
              </div>
            </div>

            <div class="units-review">
              <div *ngFor="let unit of courseData.units; let i = index" class="unit-review">
                <h5>{{ i + 1 }}. {{ unit.name }}</h5>
                <p>{{ unit.description }}</p>
                <div class="lessons-count">
                  <i class="pi pi-video"></i>
                  {{ unit.lessons?.length || 0 }} دروس
                </div>
                <div class="lessons-preview" *ngIf="unit.lessons?.length">
                  <div *ngFor="let lesson of unit.lessons" class="lesson-preview">
                    <i class="pi pi-play"></i>
                    <span>{{ lesson.title }}</span>
                    <span class="lesson-duration">({{ formatDuration(lesson.duration || 0) }})</span>
                  </div>
                </div>
              </div>
            </div>
        </div>

      </div>
    </div>
  </div>

  <div class="messages-container">
    <div *ngIf="errorMsg" class="alert alert-danger">
      <i class="pi pi-exclamation-circle"></i>
      {{ errorMsg }}
    </div>
    <div *ngIf="successMsg" class="alert alert-success">
      <i class="pi pi-check-circle"></i>
      {{ successMsg }}
    </div>
  </div>

  <!-- ✅ Add this after messages container for debugging -->
<div class="debug-section" *ngIf="!isLoading && false" style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
  <h5>Debug Info</h5>
  <p><strong>Step 1 Valid:</strong> {{ formState.steps[0].isValid }}</p>
  <p><strong>Step 2 Valid:</strong> {{ formState.steps[1].isValid }}</p>
  <p><strong>Can Go Next:</strong> {{ canGoNext }}</p>
  <p><strong>Units Count:</strong> {{ courseData.units.length }}</p>
  <div *ngFor="let unit of courseData.units; let i = index">
    <p><strong>Unit {{ i + 1 }}:</strong> {{ unit.name || 'No name' }} ({{ unit.lessons?.length || 0 }} lessons)</p>
    <div *ngFor="let lesson of unit.lessons; let j = index" style="margin-left: 20px;">
      <p><strong>Lesson {{ j + 1 }}:</strong> {{ lesson.title || 'No title' }} 
        - Type: {{ lesson.lessonType }} 
        - Video: {{ lesson.videoUrl ? 'Yes' : 'No' }} 
        - PDF: {{ lesson.document ? 'Yes' : 'No' }}
      </p>
    </div>
  </div>
</div>

<div class="form-actions">
  <div class="actions-left">
    <button type="button" class="btn btn-secondary" (click)="cancel()" [disabled]="isSaving">
      <i class="pi pi-times"></i>
      إلغاء
    </button>
  </div>

  <div class="actions-center">
    <button
      type="button"
      class="btn btn-primary"
      (click)="previousStep()"
      [disabled]="isFirstStep || isSaving"
      *ngIf="!isFirstStep"
    >
      <i class="pi pi-arrow-right"></i>
      السابق
    </button>

    <button
      type="button"
      class="btn btn-primary"
      (click)="nextStep()
      "
      [disabled]="!canGoNext || isSaving"
      *ngIf="!isLastStep"
    >
      التالي
      <i class="pi pi-arrow-left"></i>
    </button>
  </div>

  <div class="actions-right" *ngIf="isLastStep">
    <!-- If DRAFT: keep Save as Draft + Publish -->
    <ng-container *ngIf="courseData.subject.status !== 'published'; else publishedActions">
      <button
        type="button"
        class="btn btn-info"
        (click)="saveCourse()"
        [disabled]="!formState.isValid || isSaving"
      >
        <i class="pi pi-save" *ngIf="!isSaving"></i>
        <i class="pi pi-spinner pi-spin" *ngIf="isSaving"></i>
        {{ isSaving ? 'جاري الحفظ...' : 'حفظ كمسودة' }}
      </button>

      <button
        type="button"
        class="btn btn-success"
        (click)="publishCourse()"
        [disabled]="!formState.isValid || isSaving"
      >
        <i class="pi pi-globe" *ngIf="!isSaving"></i>
        <i class="pi pi-spinner pi-spin" *ngIf="isSaving"></i>
        {{ isSaving ? 'جاري النشر...' : 'نشر الكورس' }}
      </button>
    </ng-container>

    <!-- If PUBLISHED: show Save changes + Unpublish -->
    <ng-template #publishedActions>
      <button
        type="button"
        class="btn btn-success"
        (click)="saveCourse()"
        [disabled]="!formState.isValid || isSaving"
      >
        <i class="pi pi-check" *ngIf="!isSaving"></i>
        <i class="pi pi-spinner pi-spin" *ngIf="isSaving"></i>
        {{ isSaving ? 'جارِ حفظ التعديلات...' : 'حفظ التعديلات' }}
      </button>

      <button
        type="button"
        class="btn btn-danger"
        (click)="unpublishCourse()"
        [disabled]="isSaving"
      >
        <i class="pi pi-eye-slash" *ngIf="!isSaving"></i>
        <i class="pi pi-spinner pi-spin" *ngIf="isSaving"></i>
        إلغاء النشر
      </button>
    </ng-template>
  </div>
</div>
</div>