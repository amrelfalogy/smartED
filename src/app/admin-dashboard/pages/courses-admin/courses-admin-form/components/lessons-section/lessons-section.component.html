<div class="lesson-section" [class.expanded]="isExpanded">
  <div class="lesson-header" (click)="toggleExpansion()">
    <div class="lesson-info">
      <div class="lesson-number">{{ lessonIndex + 1 }}</div>
      <div class="lesson-details">
        <h4 class="lesson-title">{{ lessonForm.get('title')?.value || 'درس جديد' }}</h4>
        <div class="lesson-meta">
          <span class="lesson-type" *ngIf="selectedLessonType">
            <i class="pi" [style.color]="selectedLessonType.color"></i>
            {{ selectedLessonType.label }}
          </span>
          <span class="lesson-duration" *ngIf="lessonForm.get('duration')?.value">
            <i class="pi pi-clock"></i>
            {{ formatDuration(lessonForm.get('duration')?.value) }}
          </span>
          <span class="lesson-difficulty" *ngIf="selectedDifficulty">
            <i class="pi" [style.color]="selectedDifficulty.color"></i>
            {{ selectedDifficulty.label }}
          </span>
        </div>
      </div>
    </div>

    <div class="lesson-actions" (click)="$event.stopPropagation()">
      <button type="button" class="btn btn-sm btn-outline-secondary" (click)="toggleExpansion()" title="{{ isExpanded ? 'إخفاء التفاصيل' : 'عرض التفاصيل' }}">
        <i class="pi" [ngClass]="isExpanded ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
      </button>
      <button type="button" class="btn btn-sm btn-outline-danger" (click)="deleteLesson()" title="حذف الدرس">
        <i class="pi pi-trash"></i>
      </button>
    </div>
  </div>

  <div class="lesson-content" *ngIf="isExpanded">
    <form [formGroup]="lessonForm" class="lesson-form">
      <input type="hidden" formControlName="id" />
      <input type="hidden" formControlName="unitId" />
      <input type="hidden" formControlName="order" />

      <!-- Basic info -->
      <div class="form-section">
        <h6 class="section-title">
          <i class="pi pi-info-circle"></i>
          معلومات أساسية
        </h6>
        <div class="row">
          <div class="col-md-12">
            <div class="form-group">
              <label class="form-label">عنوان الدرس <span class="required">*</span></label>
              <input type="text" class="form-control" formControlName="title" [class.is-invalid]="isFieldInvalid('title')" placeholder="أدخل عنوان الدرس" />
              <div class="invalid-feedback" *ngIf="isFieldInvalid('title')">{{ getFieldError('title') }}</div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">وصف الدرس <span class="required">*</span></label>
          <textarea class="form-control" formControlName="description" rows="4" [class.is-invalid]="isFieldInvalid('description')" placeholder="وصف مفصل لمحتوى الدرس"></textarea>
          <div class="invalid-feedback" *ngIf="isFieldInvalid('description')">{{ getFieldError('description') }}</div>
        </div>
      </div>

      <!-- Settings -->
      <div class="form-section">
        <h6 class="section-title"><i class="pi pi-cog"></i> إعدادات الدرس</h6>
        <div class="row">
          <div class="col-md-4">
            <div class="form-group">
              <label class="form-label">المدة (ثواني)</label>
              <input type="number" class="form-control" formControlName="duration" min="0" placeholder="0" />
              <div class="form-text">يمكن تركها صفر واحتسابها لاحقاً</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label class="form-label">المستوى <span class="required">*</span></label>
              <select class="form-select" formControlName="difficulty" [class.is-invalid]="isFieldInvalid('difficulty')">
                <option value="">اختر المستوى</option>
                <option *ngFor="let d of difficultyOptions" [value]="d.value">{{ d.label }}</option>
              </select>
              <div class="invalid-feedback" *ngIf="isFieldInvalid('difficulty')">{{ getFieldError('difficulty') }}</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label class="form-label">نوع المحتوى <span class="required">*</span></label>
              <select class="form-select" formControlName="lessonType" [class.is-invalid]="isFieldInvalid('lessonType')">
                <option value="">اختر نوع المحتوى</option>
                <option *ngFor="let lt of lessonTypes" [value]="lt.value">{{ lt.label }}</option>
              </select>
              <div class="invalid-feedback" *ngIf="isFieldInvalid('lessonType')">{{ getFieldError('lessonType') }}</div>
            </div>
          </div>
        </div>

        <!-- Validation message for required media -->
        <div class="alert alert-warning py-2 px-3 mt-2" *ngIf="contentMissingType === 'video'">
          <i class="pi pi-exclamation-triangle me-2"></i>
          يجب إضافة فيديو واحد على الأقل عند اختيار نوع المحتوى "فيديو"
        </div>
        <div class="alert alert-warning py-2 px-3 mt-2" *ngIf="contentMissingType === 'document'">
          <i class="pi pi-exclamation-triangle me-2"></i>
          يجب إضافة مستند واحد على الأقل عند اختيار نوع المحتوى "PDF" أو "مستند"
        </div>
      </div>

      <!-- Media management -->
      <div class="form-section">
        <h6 class="section-title">
          <i class="pi pi-video"></i>
          الوسائط
        </h6>

        <!-- Videos (first URL will be sent as videoUrl) -->
        <div class="content-upload-section">
          <label class="form-label"><i class="pi pi-video"></i> روابط الفيديو</label>
          <div class="upload-area" [class.has-content]="videosFA.length > 0">
            <div class="upload-input-group">
              <input type="url" class="form-control" placeholder="https://example.com/video.mp4" #videoUrlInput />
              <button type="button" class="btn btn-primary" (click)="addVideoUrl(videoUrlInput)">
                <i class="pi pi-plus"></i>
                إضافة رابط
              </button>
              <label class="btn btn-outline-secondary mb-0">
                <i class="pi pi-upload"></i>
                رفع ملف فيديو
                <input type="file" accept="video/*" class="d-none" (change)="onVideoFileSelected($event)" />
              </label>
            </div>
            <div class="upload-progress" *ngIf="isLoadingMedia">
              <div class="progress">
                <div class="progress-bar" [style.width.%]="uploadProgress"></div>
              </div>
              <small>جاري تحميل الوسائط... {{ uploadProgress }}%</small>
            </div>
            <div class="content-status success" *ngIf="videosFA.length > 0">
              <i class="pi pi-check-circle"></i>
              <span>تمت إضافة {{ videosFA.length }} فيديو</span>
            </div>
          </div>
          <div class="video-list mt-2" *ngIf="videosFA.length > 0">
            <div class="d-flex align-items-center gap-2 mb-2" *ngFor="let ctrl of videosFA.controls; let i = index">
              <span class="badge bg-light text-dark">#{{ i + 1 }}</span>
              <input type="text" class="form-control" [value]="ctrl.value" readonly />
              <button type="button" class="btn btn-outline-secondary btn-sm" (click)="moveVideo(i, 'up')" [disabled]="i===0">
                <i class="pi pi-arrow-up"></i>
              </button>
              <button type="button" class="btn btn-outline-secondary btn-sm" (click)="moveVideo(i, 'down')" [disabled]="i===videosFA.length-1">
                <i class="pi pi-arrow-down"></i>
              </button>
              <button type="button" class="btn btn-outline-danger btn-sm" (click)="removeVideo(i)">
                <i class="pi pi-trash"></i>
              </button>
            </div>
          </div>
          <small class="text-muted d-block mt-1">
            سيتم إرسال أول رابط فقط إلى الخادم كـ videoUrl.
          </small>
        </div>

        <!-- Documents (first URL sent as pdfUrl) -->
        <div class="content-upload-section mt-3">
          <label class="form-label"><i class="pi pi-file"></i> مستندات الدرس (اختياري)</label>
          <div class="upload-area" [class.has-content]="documentsFA.length > 0">
            <div class="upload-input-group">
              <input type="url" class="form-control" placeholder="https://example.com/file.pdf" #docUrlInput />
              <button type="button" class="btn btn-outline-primary" (click)="addDocumentUrl(docUrlInput)">
                <i class="pi pi-plus"></i>
                إضافة رابط
              </button>
              <label class="btn btn-outline-secondary mb-0">
                <i class="pi pi-upload"></i>
                رفع ملف مستند
                <input type="file" accept=".pdf,.doc,.docx,.txt,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,text/plain" class="d-none" (change)="onDocumentFileSelected($event)" />
              </label>
            </div>
            <div class="upload-progress" *ngIf="isLoadingMediaDoc">
              <div class="progress">
                <div class="progress-bar bg-info" [style.width.%]="uploadProgressDoc"></div>
              </div>
              <small>جاري تحميل المستند... {{ uploadProgressDoc }}%</small>
            </div>
            <div class="content-status success" *ngIf="documentsFA.length > 0">
              <i class="pi pi-check-circle"></i>
              <span>تمت إضافة {{ documentsFA.length }} مستند</span>
            </div>
          </div>
          <div class="doc-list mt-2" *ngIf="documentsFA.length > 0">
            <div class="d-flex align-items-center gap-2 mb-2" *ngFor="let ctrl of documentsFA.controls; let i = index">
              <span class="badge bg-light text-dark">#{{ i + 1 }}</span>
              <input type="text" class="form-control" [value]="ctrl.value" readonly />
              <a class="btn btn-outline-primary btn-sm" [href]="ctrl.value" target="_blank" rel="noopener">
                <i class="pi pi-external-link"></i>
              </a>
              <button type="button" class="btn btn-outline-danger btn-sm" (click)="removeDocument(i)">
                <i class="pi pi-trash"></i>
              </button>
            </div>
          </div>
          <small class="text-muted d-block mt-1">
            سيتم إرسال أول رابط فقط إلى الخادم كـ pdfUrl.
          </small>
        </div>
      </div>

      <!-- Pricing -->
      <div class="form-section">
        <h6 class="section-title"><i class="pi pi-credit-card"></i> التسعير</h6>
        <div class="row">
          <div class="col-md-4">
            <label class="form-label">السعر</label>
            <input type="number" class="form-control" formControlName="price" min="0" 
              [class.is-invalid]="isFieldInvalid('price')"
              [readonly]="lessonForm.get('isFree')?.value"
              [class.bg-light]="lessonForm.get('isFree')?.value"
            />
            <div class="form-text">اتركه 0 إذا كان الدرس مجانياً أو حدده بحسب السياسة</div>
            <div class="invalid-feedback" *ngIf="isFieldInvalid('price')">
              {{ getFieldError('price') }}
            </div>  
          </div>
          <div class="col-md-3">
            <label class="form-label">العملة</label>
            <select class="form-select" formControlName="currency">
              <option value="EGP">EGP</option>
            </select>
          </div>
          <div class="col-md-5 d-flex align-items-end">
            <div class="form-check mt-4">
              <input class="form-check-input" type="checkbox" formControlName="isFree" id="isFreeChk{{lessonIndex}}" />
              <label class="form-check-label" [for]="'isFreeChk' + lessonIndex">
                مجاني
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Options -->
      <div class="form-section">
        <h6 class="section-title"><i class="pi pi-sliders-h"></i> خيارات الدرس</h6>
        <div class="options-grid">
          <div class="option-card">
            <label class="form-check">
              <input class="form-check-input" type="checkbox" formControlName="isActive" />
              <span class="form-check-label">
                <i class="pi pi-eye"></i> نشط
              </span>
            </label>
          </div>
        </div>
      </div>

      <!-- Live session fields (when lessonType = live) -->
      <div class="form-section" *ngIf="lessonForm.get('lessonType')?.value === 'live'">
        <h6 class="section-title"><i class="pi pi-users"></i> جلسة مباشرة (Zoom)</h6>
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label class="form-label">رابط Zoom</label>
              <input type="url" class="form-control" formControlName="zoomUrl" placeholder="https://zoom.us/j/..." />
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label class="form-label">معرف الاجتماع</label>
              <input type="text" class="form-control" formControlName="zoomMeetingId" />
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label class="form-label">الرمز</label>
              <input type="text" class="form-control" formControlName="zoomPasscode" />
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">التاريخ/الوقت</label>
          <input type="datetime-local" class="form-control" formControlName="scheduledAt" />
          <div class="form-text">اترك القيمة فارغة إذا لم يتم التحديد بعد (سيتم إرسال null بأمان)</div>
        </div>
      </div>
    </form>

    <div class="form-status" [class.expanded]="isExpanded">
      <div class="status-indicator" [class.valid]="isFormValid" [class.invalid]="!isFormValid">
        <i class="pi" [ngClass]="isFormValid ? 'pi-check-circle' : 'pi-exclamation-circle'"></i>
        <span>{{ isFormValid ? 'الدرس مكتمل' : 'يرجى استكمال الحقول المطلوبة' }}</span>
      </div>
      <div class="completion-progress" *ngIf="!isFormValid && isExpanded">
        <div class="progress-text">مستوى الإكمال</div>
        <div class="progress">
          <div class="progress-bar" [style.width.%]="getCompletionPercentage()"></div>
        </div>
        <small>{{ getCompletionPercentage() }}% مكتمل</small>
      </div>
    </div>
  </div>
</div>