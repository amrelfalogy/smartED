<div class="students-management">
  <!-- Header Section -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="page-title">إدارة الطلاب</h1>
      <p class="text-muted">إدارة حسابات الطلاب وبياناتهم</p>
    </div>
    <div class="header-actions">
      <button type="button" class="btn btn-primary">
        <i class="pi pi-plus me-2"></i>
        إضافة طالب جديد
      </button>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
      <app-card [showHeader]="false" blockClass="stat-card">
        <div class="stat-content">
          <div class="stat-icon bg-primary">
            <i class="pi pi-users"></i>
          </div>
          <div class="stat-details">
            <h4 class="stat-value">
              <span *ngIf="!isLoadingStats">{{ formatStatNumber(stats.total) }}</span>
              <div *ngIf="isLoadingStats" class="stat-loading">
                <div class="spinner-border spinner-border-sm" role="status"></div>
              </div>
            </h4>
            <p class="stat-label">إجمالي الطلاب</p>
          </div>
        </div>
      </app-card>
    </div>

    <div class="col-md-3 col-sm-6 mb-3">
      <app-card [showHeader]="false" blockClass="stat-card">
        <div class="stat-content">
          <div class="stat-icon bg-success">
            <i class="pi pi-check-circle"></i>
          </div>
          <div class="stat-details">
            <h4 class="stat-value">
              <span *ngIf="!isLoadingStats">{{ formatStatNumber(stats.active) }}</span>
              <div *ngIf="isLoadingStats" class="stat-loading">
                <div class="spinner-border spinner-border-sm" role="status"></div>
              </div>
            </h4>
            <p class="stat-label">طلاب نشطون</p>
          </div>
        </div>
      </app-card>
    </div>

    <div class="col-md-3 col-sm-6 mb-3">
      <app-card [showHeader]="false" blockClass="stat-card">
        <div class="stat-content">
          <div class="stat-icon bg-warning">
            <i class="pi pi-pause-circle"></i>
          </div>
          <div class="stat-details">
            <h4 class="stat-value">
              <span *ngIf="!isLoadingStats">{{ formatStatNumber(stats.inactive) }}</span>
              <div *ngIf="isLoadingStats" class="stat-loading">
                <div class="spinner-border spinner-border-sm" role="status"></div>
              </div>
            </h4>
            <p class="stat-label">طلاب غير نشطون</p>
          </div>
        </div>
      </app-card>
    </div>

    <div class="col-md-3 col-sm-6 mb-3">
      <app-card [showHeader]="false" blockClass="stat-card">
        <div class="stat-content">
          <div class="stat-icon bg-info">
            <i class="pi pi-user-plus"></i>
          </div>
          <div class="stat-details">
           <h4 class="stat-value">
              <span *ngIf="!isLoadingStats">{{ formatStatNumber(stats.recent) }}</span>
              <div *ngIf="isLoadingStats" class="stat-loading">
                <div class="spinner-border spinner-border-sm" role="status"></div>
              </div>
            </h4>
            <p class="stat-label">تسجيلات حديثة</p>
          </div>
        </div>
      </app-card>
    </div>
  </div>

  <!-- Search and Filters -->
  <app-card>
    <div class="search-section">
      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="input-group">
            <span class="input-group-text">
              <i class="pi pi-search"></i>
            </span>
            <input 
              type="text" 
              class="form-control" 
              [formControl]="searchControl"
              placeholder="البحث بالاسم أو البريد الإلكتروني...">
          </div>
        </div>
        <div class="col-md-3">
          <select class="form-select">
            <option value="">جميع الحالات</option>
            <option value="active">نشط</option>
            <option value="inactive">غير نشط</option>
          </select>
        </div>
        <div class="col-md-3 text-end">
          <div class="results-info">
            <span class="text-muted">
              {{ totalItems }} طالب
              <span *ngIf="searchControl.value">(من البحث)</span>
            </span>
          </div>
        </div>
      </div>
    </div>
  </app-card>

  <!-- Students Table -->
  <div class="students-table mt-4">
    <app-card [showHeader]="false" blockClass="table-card">
      <div class="table-responsive">
        <!-- Loading State -->
        <div *ngIf="isLoading" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">جاري التحميل...</span>
          </div>
          <p class="mt-2 text-muted">جاري تحميل بيانات الطلاب...</p>
        </div>

        <!-- Empty State -->
        <div *ngIf="!isLoading && students.length === 0" class="text-center py-5">
          <i class="pi pi-users text-muted" style="font-size: 4rem;"></i>
          <h4 class="mt-3">لا يوجد طلاب</h4>
          <p class="text-muted">
            <span *ngIf="searchControl.value">لم يتم العثور على طلاب يطابقون البحث</span>
            <span *ngIf="!searchControl.value">لم يتم تسجيل أي طلاب بعد</span>
          </p>
        </div>

        <!-- Students Table -->
        <table class="table table-hover students-table-content" *ngIf="!isLoading && students.length > 0">
          <thead>
            <tr>
              <th scope="col" class="student-col">الطالب</th>
              <th scope="col" class="contact-col">معلومات الاتصال</th>
              <th scope="col" class="status-col">الحالة</th>
              <th scope="col" class="dates-col">التواريخ</th>
              <th scope="col" class="actions-col">الإجراءات</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let student of students; trackBy: trackByUserId" class="student-row">
              <!-- Student Info -->
              <td class="student-info">
                <div class="student-profile">
                  <div class="student-avatar">
                    <img *ngIf="student.avatar" [src]="student.avatar" [alt]="getDisplayName(student)">
                    <div *ngIf="!student.avatar" class="avatar-placeholder">
                      {{ getDisplayName(student).charAt(0).toUpperCase() }}
                    </div>
                    <span class="status-indicator" [class.active]="student.isActive" [class.inactive]="!student.isActive">
                      <i class="pi" [class.pi-circle-fill]="student.isActive" [class.pi-circle]="!student.isActive"></i>
                    </span>
                  </div>
                  <div class="student-details">
                    <h6 class="student-name">{{ getDisplayName(student) }}</h6>
                    <small class="student-id text-muted">ID: {{ student.id.substring(0, 8) }}...</small>
                  </div>
                </div>
              </td>

              <!-- Contact Info -->
              <td class="contact-info">
                <div class="contact-item">
                  <i class="pi pi-envelope me-2 text-primary"></i>
                  <span class="email">{{ student.email }}</span>
                </div>
                <div class="contact-item" *ngIf="student.phone">
                  <i class="pi pi-phone me-2 text-success"></i>
                  <span class="phone">{{ student.phone }}</span>
                </div>
                <div class="contact-item" *ngIf="!student.phone">
                  <i class="pi pi-phone me-2 text-muted"></i>
                  <span class="text-muted">غير متوفر</span>
                </div>
              </td>

              <!-- Status -->
              <td class="status-info">
                <div class="status-badges">
                  <span class="badge account-status" [class.bg-success]="student.isActive" [class.bg-danger]="!student.isActive">
                    {{ student.isActive ? 'نشط' : 'غير نشط' }}
                  </span>
                  <span class="badge email-status" [class.bg-success]="student.emailVerified" [class.bg-warning]="!student.emailVerified">
                    {{ student.emailVerified ? 'بريد مُفعل' : 'بريد غير مُفعل' }}
                  </span>
                </div>
              </td>

              <!-- Dates -->
              <td class="dates-info">
                <div class="date-item">
                  <small class="text-muted">انضم في:</small>
                  <div class="date-value">{{ formatDate(student.createdAt) }}</div>
                </div>
                <div class="date-item" *ngIf="student.lastLogin">
                  <small class="text-muted">آخر دخول:</small>
                  <div class="date-value">{{ formatDate(student.lastLogin) }}</div>
                </div>
                <div class="date-item" *ngIf="!student.lastLogin">
                  <small class="text-muted">آخر دخول:</small>
                  <div class="date-value text-muted">لم يدخل بعد</div>
                </div>
              </td>

              <!-- Actions -->
              <td class="actions-info">
                <div class="action-buttons">
                  <button 
                    type="button" 
                    class="btn btn-primary btn-sm"
                    (click)="viewProfile(student)"
                    title="عرض الملف الشخصي">
                    <i class="pi pi-eye"></i>
                  </button>
                  <button 
                    type="button" 
                    class="btn btn-secondary btn-sm"
                    title="تعديل">
                    <i class="pi pi-pencil"></i>
                  </button>
                  <div class="dropdown d-inline-block">
                    <button 
                      class="btn btn-secondary btn-sm dropdown-toggle" 
                      type="button" 
                      [id]="'dropdownMenuButton' + student.id"
                      data-bs-toggle="dropdown" 
                      aria-expanded="false">
                      <i class="pi pi-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu" [attr.aria-labelledby]="'dropdownMenuButton' + student.id">
                      <li>
                        <a class="dropdown-item" href="javascript:void(0)">
                          <i class="pi pi-user me-2"></i>
                          عرض الملف الشخصي
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item" href="javascript:void(0)">
                          <i class="pi pi-envelope me-2"></i>
                          إرسال رسالة
                        </a>
                      </li>
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <a class="dropdown-item text-danger" href="javascript:void(0)">
                          <i class="pi pi-trash me-2"></i>
                          حذف الطالب
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Table Footer with Pagination -->
      <div class="table-footer" *ngIf="!isLoading && students.length > 0">
        <div class="row align-items-center">
          <div class="col-md-6">
            <div class="pagination-info">
              <span class="text-muted">
                عرض {{ (currentPage - 1) * pageSize + 1 }} إلى {{ Math.min(currentPage * pageSize, totalItems) }} 
                من أصل {{ totalItems }} طالب
              </span>
            </div>
          </div>
          <div class="col-md-6">
            <nav aria-label="Student pagination" class="d-flex justify-content-end">
              <ul class="pagination pagination-sm mb-0" *ngIf="totalPages > 1">
                <li class="page-item" [class.disabled]="currentPage === 1">
                  <button class="page-link" (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1">
                    <i class="pi pi-chevron-right"></i>
                  </button>
                </li>
                
                <!-- Show first page -->
                <li class="page-item" [class.active]="currentPage === 1" *ngIf="totalPages > 1">
                  <button class="page-link" (click)="onPageChange(1)">1</button>
                </li>

                <!-- Show ellipsis if needed -->
                <li class="page-item disabled" *ngIf="currentPage > 3">
                  <span class="page-link">...</span>
                </li>

                <!-- Show current page and neighbors -->
                <li class="page-item" 
                    *ngFor="let page of getVisiblePages()" 
                    [class.active]="currentPage === page">
                  <button class="page-link" (click)="onPageChange(page)">{{ page }}</button>
                </li>

                <!-- Show ellipsis if needed -->
                <li class="page-item disabled" *ngIf="currentPage < totalPages - 2">
                  <span class="page-link">...</span>
                </li>

                <!-- Show last page -->
                <li class="page-item" [class.active]="currentPage === totalPages" *ngIf="totalPages > 1 && totalPages !== 1">
                  <button class="page-link" (click)="onPageChange(totalPages)">{{ totalPages }}</button>
                </li>
                
                <li class="page-item" [class.disabled]="currentPage === totalPages">
                  <button class="page-link" (click)="onPageChange(currentPage + 1)" [disabled]="currentPage === totalPages">
                    <i class="pi pi-chevron-left"></i>
                  </button>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </app-card>
  </div>
</div>

<!-- User Profile Modal -->
<app-user-profile-modal
  *ngIf="showProfileModal && selectedUser"
  [user]="selectedUser"
  [isVisible]="showProfileModal"
  (close)="closeProfileModal()"
  (userUpdated)="onUserUpdated($event)"
  (userDeleted)="onUserDeleted($event)">
</app-user-profile-modal>