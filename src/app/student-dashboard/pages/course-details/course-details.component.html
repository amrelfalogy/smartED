<div class="course-details-page">
  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoadingContent">
    <div class="loading-spinner">
      <i class="pi pi-spinner pi-spin"></i>
      <p>جاري تحميل تفاصيل الدورة...</p>
    </div>
  </div>

  <!-- Error Message -->
  <div class="error-container" *ngIf="errorMessage && !isLoadingContent">
    <div class="alert alert-danger">
      <i class="pi pi-exclamation-triangle me-2"></i>
      {{ errorMessage }}
      <button class="btn btn-outline-danger btn-sm ms-2" (click)="loadCourseDetails()">
        <i class="pi pi-refresh me-1"></i>
        إعادة المحاولة
      </button>
    </div>
  </div>

  <!-- ✅ Admin Mode Indicator -->
  <div *ngIf="isAdminMode && course" class="admin-mode-indicator">
    <div class="alert alert-info">
      <i class="pi pi-info-circle me-2"></i>
      <strong>وضع المدير:</strong> أنت تعرض هذا الكورس كمدير
    </div>
  </div>

  <!-- Course Details Content -->
  <div class="course-content" *ngIf="!isLoadingContent && course">
    <!-- Course Header -->
    <div class="course-header">
      <button class="btn btn-ghost back-btn" (click)="goBack()">
        <i class="pi pi-arrow-right me-2"></i>
        {{ isAdminMode ? 'العودة للكورسات' : 'العودة' }}
      </button>
      
      <div class="course-info">
        <div class="course-image-container">
          <img 
            [src]="course.imageUrl" 
            [alt]="course.name" 
            class="course-image" 
            onerror="this.src='assets/imgs/aboutt.jpg'"
          >
          <div class="course-overlay">
            <div class="enrollment-status" [class]="enrollmentStatus" *ngIf="showEnrollmentActions">
              <i class="pi pi-check-circle" *ngIf="enrollmentStatus === 'enrolled'"></i>
              <i class="pi pi-lock" *ngIf="enrollmentStatus === 'not_enrolled'"></i>
              <i class="pi pi-clock" *ngIf="enrollmentStatus === 'pending'"></i>
              <span *ngIf="enrollmentStatus === 'enrolled'">مسجل</span>
              <span *ngIf="enrollmentStatus === 'not_enrolled'">غير مسجل</span>
              <span *ngIf="enrollmentStatus === 'pending'">في انتظار التأكيد</span>
            </div>
            <!-- ✅ Admin Status Indicator -->
            <div class="course-status" *ngIf="isAdminMode">
              <span class="status-badge" [class]="'status-' + course.status">
                <i class="pi pi-{{ course.status === 'published' ? 'eye' : 'eye-slash' }}"></i>
                {{ course.status === 'published' ? 'منشور' : 'مسودة' }}
              </span>
            </div>
          </div>
        </div>
        
        <div class="course-details">
          <h1 class="course-title">{{ course.name }}</h1>
          <p class="course-description">{{ course.description }}</p>
          
          <div class="course-meta">
            <div class="meta-item" *ngIf="course.instructorName">
              <i class="pi pi-user-tie"></i>
              <span>{{ course.instructorName }}</span>
            </div>
            <div class="meta-item" *ngIf="course.duration">
              <i class="pi pi-clock"></i>
              <span>{{ course.duration }}</span>
            </div>
            <div class="meta-item" *ngIf="course.difficulty">
              <i class="pi pi-signal"></i>
              <span class="difficulty-badge" [class]="'badge-' + getDifficultyColor(course.difficulty)">
                {{ getDifficultyLabel(course.difficulty) }}
              </span>
            </div>
            <div class="meta-item" *ngIf="hasLessons">
              <i class="pi pi-play-circle"></i>
              <span>{{ lessons.length }} درس</span>
            </div>
            <div class="meta-item" *ngIf="course.sessionType">
              <i class="pi pi-tag"></i>
              <span>
                {{
                  course.sessionType === 'center_recorded' || course.sessionType === 'recorded' ? 'مسجل - المركز' :
                  course.sessionType === 'studio' ? 'منتج - الاستوديو' :
                  course.sessionType === 'live' || course.sessionType === 'zoom' ? 'مباشر' : 'غير محدد'
                }}
              </span>
            </div>
          </div>

          <!-- ✅ NEW: Header Enrollment Actions -->
          <div class="header-enrollment-actions" *ngIf="canEnroll && hasLessons">
            <div class="enrollment-summary" *ngIf="hasPartialAccess">
              <div class="access-indicator">
                <i class="pi pi-info-circle"></i>
                <span>لديك وصول لبعض الدروس</span>
              </div>
            </div>
            
            <div class="enrollment-buttons">
              <button 
                class="btn btn-enrollment-primary"
                (click)="navigateToPlanSubject()"
              >
                <i class="pi pi-credit-card me-2"></i>
                <span class="btn-text">
                  {{ hasPartialAccess ? 'اشترك في المادة كاملة' : 'سجل في المادة' }}
                </span>
              </button>            
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ✅ Admin Actions Section -->
    <div *ngIf="isAdminMode" class="admin-actions">
      <div class="actions-bar">
        <button 
          class="btn btn-primary"
          (click)="editCourse()"
        >
          <i class="pi pi-pencil me-2"></i>
          تعديل الكورس
        </button>
        
        <button 
          class="btn btn-outline-success"
          (click)="toggleCourseStatus()"
          [disabled]="isLoading"
        >
          <i class="pi pi-{{ course.status === 'published' ? 'eye-slash' : 'eye' }} me-2"></i>
          {{ course.status === 'published' ? 'إلغاء النشر' : 'نشر الكورس' }}
        </button>
        
        <button 
          class="btn btn-outline-info"
          (click)="viewStudents()"
        >
          <i class="pi pi-users me-2"></i>
          عرض الطلاب
        </button>
      </div>
    </div>

    <!-- ✅ Success Message -->
    <div class="success-container" *ngIf="successMessage">
      <div class="alert alert-success">
        <i class="pi pi-check-circle me-2"></i>
        {{ successMessage }}
      </div>
    </div>

    <!-- ✅ Content Based on Available Data -->
    <div *ngIf="hasLessons" class="course-curriculum-container">
      <!-- Session Type Display (subject-level) -->
      <div class="lesson-type-selection" *ngIf="course?.sessionType">
        <div class="section-header">
          <h2 class="section-title">
            <i class="pi pi-list me-2"></i>
            نوع تقديم المحتوى
          </h2>
          <p class="section-description">هذا الكورس يقدم محتواه بطريقة واحدة</p>
        </div>

        <div class="lesson-type-cards">
          <!-- Center Recorded Card -->
          <div class="lesson-type-card" 
               [class.selected]="selectedLessonType === 'center_recorded'"
               [class.disabled]="course.sessionType !== 'center_recorded' && course.sessionType !== 'recorded'">
            <div class="card-header">
              <div class="card-icon center-recorded">
                <i class="pi pi-video"></i>
              </div>
              <div class="card-status" *ngIf="selectedLessonType === 'center_recorded'">
                <span class="status-badge selected">محدد</span>
              </div>
            </div>
            <div class="card-content">
              <h3 class="card-title">الدروس المسجلة - المركز</h3>
              <p class="card-description">دروس مسجلة في المركز التعليمي بجودة عالية مع شرح تفصيلي</p>
            </div>
          </div>

          <!-- Studio Produced Card -->            
          <div class="lesson-type-card" 
               [class.selected]="selectedLessonType === 'studio_produced'"
               [class.disabled]="course.sessionType !== 'studio'">
            <div class="card-header">
              <div class="card-icon studio-produced">
                <i class="pi pi-play-circle"></i>
              </div>
              <div class="card-status" *ngIf="selectedLessonType === 'studio_produced'">
                <span class="status-badge selected">محدد</span>
              </div>
              <div class="popular-badge" *ngIf="course.sessionType === 'studio'">الأكثر شعبية</div>
            </div>
            <div class="card-content">
              <h3 class="card-title">الدروس المنتجة - الاستوديو</h3>
              <p class="card-description">دروس منتجة في الاستوديو بجودة احترافية مع مؤثرات بصرية</p>
            </div>
          </div>

          <!-- Live Zoom Card (Disabled placeholder) -->
          <div class="lesson-type-card disabled">
            <div class="card-header">
              <div class="card-icon zoom-meeting">
                <i class="pi pi-users"></i>
              </div>
              <div class="card-status">
                <span class="status-badge disabled">قريباً</span>
              </div>
            </div>
            <div class="card-content">
              <h3 class="card-title">الجلسات المباشرة - Zoom</h3>
              <p class="card-description">جلسات تفاعلية مباشرة عبر Zoom مع إمكانية الأسئلة والمناقشة</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ✅ Course Units and Lessons (Enhanced UI) -->
      <div class="course-curriculum">
        <div class="curriculum-header sticky">
          <h2 class="curriculum-title">
            <i class="pi pi-play-circle me-2"></i>
            محتوى الدورة
          </h2>
          <div class="lesson-actions">
            <button class="btn btn-sm"
                    [class.btn-primary]="isAdminMode"
                    [class.btn-danger]="!isAdminMode">
              <span *ngIf="isAdminMode"><i class="pi pi-eye me-1"></i> معاينة</span>
              <span *ngIf="!isAdminMode "><i class="pi pi-play me-1"></i> ابدأ</span>
            </button>
          </div>
          <div class="curriculum-stats">
            <span class="stat-item chip">
              <i class="pi pi-play-circle"></i>
              {{ lessons.length }} درس
            </span>
            <span class="stat-item chip">
              <i class="pi pi-clock"></i>
              {{ getTotalDuration() }}
            </span>
            <span class="stat-item chip type-chip" *ngIf="course?.sessionType">
              <i class="pi pi-tag"></i>
              {{
                course.sessionType === 'center_recorded' || course.sessionType === 'recorded' ? 'مسجل - المركز' :
                course.sessionType === 'studio' ? 'منتج - الاستوديو' :
                course.sessionType === 'live' || course.sessionType === 'zoom' ? 'مباشر' : 'غير محدد'
              }}
            </span>
          </div>
        </div>

        <!-- Units as an accessible accordion (no TS needed) -->
        <div class="units-container" *ngIf="units.length > 0">
          <details
            class="unit-card"
            *ngFor="let unit of units; let unitIndex = index"
            [attr.open]="unitIndex === 0 ? true : null"
          >
            <summary class="unit-header" >
              <div class="unit-info">
                <div class="unit-title-row">
                  <h3 class="unit-title" [title]="unit.name">{{ unit.name }}</h3>
                  <span class="unit-badge">
                    <i class="pi pi-bookmark"></i>
                    وحدة {{ unitIndex + 1 }}
                  </span>
                </div>
                <p class="unit-description" *ngIf="unit.description" [title]="unit.description">{{ unit.description }}</p>
              </div>
              <div class="unit-stats">
                <span class="lessons-count">
                  <i class="pi pi-play"></i>
                  {{ unit.lessons?.length || 0 }} دروس
                </span>
              </div>
              <div class="summary-caret" aria-hidden="true">
                <i class="pi pi-chevron-down"></i>
              </div>
            </summary>

            <!-- Lessons List -->
            <div class="lessons-list" *ngIf="unit.lessons && unit.lessons.length > 0">
              <div class="lesson-item" 
                   *ngFor="let lesson of unit.lessons; let lessonIndex = index"
                   [class.locked]="!isAdminMode && !lesson.isFree && !lesson.hasAccess"
                   [class.free]="lesson.isFree"
                   [class.accessible]="isAdminMode || lesson.hasAccess"
                   [class.admin-preview]="isAdminMode">

                <div class="lesson-content" (click)="startLesson(lesson)" tabindex="0" role="button" [attr.aria-label]="'فتح الدرس ' + lesson.title">
                  <div class="lesson-number">
                    <span>{{ lessonIndex + 1 }}</span>
                  </div>

                  <div class="lesson-body">
                    <div class="lesson-title-row">
                      <div class="lesson-icon">
                        <i class="pi pi-play-circle" *ngIf="isAdminMode || lesson.isFree || lesson.hasAccess"></i>
                        <i class="pi pi-lock" *ngIf="!isAdminMode && !lesson.isFree && !lesson.hasAccess"></i>
                        <i class="pi pi-credit-card" *ngIf="!isAdminMode && lesson.requiresPayment"></i>
                      </div>
                      <h4 class="lesson-title" [title]="lesson.title">{{ lesson.title }}</h4>
                    </div>

                    <p class="lesson-description" *ngIf="lesson.description" [title]="lesson.description">
                      {{ lesson.description }}
                    </p>

                    <div class="lesson-meta">
                      <span class="meta-chip" *ngIf="lesson.duration">
                        <i class="pi pi-clock"></i>
                        {{ formatDuration(lesson.duration) }}
                      </span>
                      <span class="meta-chip difficulty" [class]="'difficulty-' + lesson.difficulty" *ngIf="lesson.difficulty">
                        <i class="pi pi-signal"></i>
                        {{ getDifficultyLabel(lesson.difficulty) }}
                      </span>
                      <span class="meta-chip type" *ngIf="course?.sessionType">
                        <i class="pi pi-tag"></i>
                        {{
                          course.sessionType === 'center_recorded' || course.sessionType === 'recorded' ? 'مركز'
                          : course.sessionType === 'studio' ? 'استوديو'
                          : course.sessionType === 'live' || course.sessionType === 'zoom' ? 'مباشر' : 'غير محدد'
                        }}
                      </span>
                      <span class="meta-chip free-chip" *ngIf="lesson.isFree">
                        <i class="pi pi-gift"></i>
                        مجاني
                      </span>
                      <span class="meta-chip locked-chip" *ngIf="!isAdminMode && !lesson.isFree && !lesson.hasAccess && !lesson.requiresPayment">
                        <i class="pi pi-lock"></i>
                        مقفل
                      </span>
                      <span class="meta-chip pay-chip" *ngIf="!isAdminMode && lesson.requiresPayment">
                        <i class="pi pi-credit-card"></i>
                        يحتاج دفع
                      </span>
                    </div>
                  </div>

                  <div class="lesson-actions">
                    <button class="btn btn-sm"
                            [class.btn-primary]="isAdminMode || lesson.isFree || lesson.hasAccess"
                            [class.btn-warning]="!isAdminMode && lesson.requiresPayment && !lesson.hasAccess"
                            [class.btn-outline-secondary]="!isAdminMode && !lesson.isFree && !lesson.hasAccess && !lesson.requiresPayment"
                            (click)="onLessonAction(lesson, $event)">
                      <span *ngIf="isAdminMode"><i class="pi pi-eye me-1"></i> معاينة</span>
                      <span *ngIf="!isAdminMode && (lesson.isFree || lesson.hasAccess)"><i class="pi pi-play me-1"></i> ابدأ</span>
                      <span *ngIf="!isAdminMode && lesson.requiresPayment && !lesson.hasAccess"><i class="pi pi-credit-card me-1"></i> ادفع</span>
                      <span *ngIf="!isAdminMode && !lesson.isFree && !lesson.hasAccess && !lesson.requiresPayment"><i class="pi pi-lock me-1"></i> مقفل</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- No lessons in unit -->
            <div class="no-lessons-message" *ngIf="!unit.lessons || unit.lessons.length === 0">
              <div class="no-lessons-content">
                <i class="pi pi-exclamation-triangle"></i>
                <h4>لا توجد دروس في هذه الوحدة</h4>
                <p>سيظهر المحتوى هنا بمجرد إضافة الدروس</p>
              </div>
            </div>
          </details>
        </div>

        <!-- No Lessons Message -->
        <div class="no-lessons-message" *ngIf="units.length === 0">
          <div class="no-lessons-content">
            <i class="pi pi-exclamation-triangle"></i>
            <h4>لا توجد دروس متاحة</h4>
            <p>لا توجد دروس من النوع المحدد في هذه الدورة حالياً</p>
          </div>
        </div>
      </div>

      <!-- ✅ Enhanced Enrollment CTA (Students Only) -->
      <div class="enrollment-cta" *ngIf="canEnroll && hasLessons">
        <div class="cta-content">
          <!-- ✅ Different messages based on access status -->
          <div *ngIf="!hasPartialAccess" class="cta-full-enrollment">
            <h3>هل أنت مستعد للبدء؟</h3>
            <p>اشترك في المادة للوصول إلى جميع الدروس والمواد التعليمية</p>
          </div>
          
          <div *ngIf="hasPartialAccess" class="cta-upgrade-enrollment">
            <h3>احصل على الوصول الكامل</h3>
            <p>لديك وصول لبعض الدروس، اشترك في المادة كاملة للحصول على جميع المحتويات</p>
            <div class="access-status">
              <i class="pi pi-info-circle text-info me-2"></i>
              <small class="text-muted">لديك وصول لدروس منفردة من هذه المادة</small>
            </div>
          </div>

          <button class="btn btn-primary btn-lg" (click)="navigateToPlanSubject()">
            <i class="pi pi-credit-card me-2"></i>
            {{ hasPartialAccess ? 'اشترك في المادة كاملة' : 'سجل في المادة' }}
          </button>
          
          <!-- ✅ Optional: Show current access info -->
          <div class="current-access-info" *ngIf="hasPartialAccess">
            <small class="text-info">
              <i class="pi pi-check-circle me-1"></i>
              لديك حالياً وصول لدروس منفردة - اشترك للحصول على جميع المحتويات
            </small>
          </div>
        </div>
      </div>

    <!-- ✅ No Content Available -->
    <div class="no-content-container" *ngIf="!hasLessons && !isLoadingContent">
      <div class="no-content">
        <div class="no-content-icon">
          <i class="pi pi-book"></i>
        </div>
        <h3>لا يوجد محتوى متاح</h3>
        <p>لم يتم إضافة وحدات أو دروس لهذا الكورس بعد</p>
        <button 
          *ngIf="isAdminMode" 
          class="btn btn-primary"
          (click)="editCourse()"
        >
          <i class="pi pi-plus me-2"></i>
          إضافة محتوى
        </button>
      </div>
    </div>
  </div>
</div>