<div class="course-details-page">
  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoadingContent">
    <div class="loading-spinner">
      <i class="pi pi-spinner pi-spin"></i>
      <p>جاري تحميل تفاصيل الدورة...</p>
    </div>
  </div>

  <!-- Error Message -->
  <div class="error-container" *ngIf="errorMessage && !isLoadingContent">
    <div class="alert alert-danger">
      <i class="pi pi-exclamation-triangle me-2"></i>
      {{ errorMessage }}
      <button class="btn btn-outline-danger btn-sm ms-2" (click)="loadCourseDetails()">
        <i class="pi pi-refresh me-1"></i>
        إعادة المحاولة
      </button>
    </div>
  </div>

  <!-- ✅ Admin Mode Indicator -->
  <div *ngIf="isAdminMode && course" class="admin-mode-indicator">
    <div class="alert alert-info">
      <i class="pi pi-info-circle me-2"></i>
      <strong>وضع المدير:</strong> أنت تعرض هذا الكورس كمدير
    </div>
  </div>

  <!-- Course Details Content -->
  <div class="course-content" *ngIf="!isLoadingContent && course">
    <!-- Course Header -->
    <div class="course-header">
      <button class="btn btn-ghost back-btn" (click)="goBack()">
        <i class="pi pi-arrow-right me-2"></i>
        {{ isAdminMode ? 'العودة للكورسات' : 'العودة' }}
      </button>
      
      <div class="course-info">
        <div class="course-image-container">
          <img 
            [src]="course.imageUrl" 
            [alt]="course.name" 
            class="course-image" 
            onerror="this.src='assets/imgs/course-placeholder.jpg'"
          >
          <div class="course-overlay">
            <div class="enrollment-status" [class]="enrollmentStatus" *ngIf="showEnrollmentActions">
              <i class="pi pi-check-circle" *ngIf="enrollmentStatus === 'enrolled'"></i>
              <i class="pi pi-lock" *ngIf="enrollmentStatus === 'not_enrolled'"></i>
              <i class="pi pi-clock" *ngIf="enrollmentStatus === 'pending'"></i>
              <span *ngIf="enrollmentStatus === 'enrolled'">مسجل</span>
              <span *ngIf="enrollmentStatus === 'not_enrolled'">غير مسجل</span>
              <span *ngIf="enrollmentStatus === 'pending'">في انتظار التأكيد</span>
            </div>
            <!-- ✅ Admin Status Indicator -->
            <div class="course-status" *ngIf="isAdminMode">
              <span class="status-badge" [class]="'status-' + course.status">
                <i class="pi pi-{{ course.status === 'published' ? 'eye' : 'eye-slash' }}"></i>
                {{ course.status === 'published' ? 'منشور' : 'مسودة' }}
              </span>
            </div>
          </div>
        </div>
        
        <div class="course-details">
          <h1 class="course-title">{{ course.name }}</h1>
          <p class="course-description">{{ course.description }}</p>
          
          <div class="course-meta">
            <div class="meta-item" *ngIf="course.instructorName">
              <i class="pi pi-user-tie"></i>
              <span>{{ course.instructorName }}</span>
            </div>
            <div class="meta-item" *ngIf="course.duration">
              <i class="pi pi-clock"></i>
              <span>{{ course.duration }}</span>
            </div>
            <div class="meta-item" *ngIf="course.difficulty">
              <i class="pi pi-signal"></i>
              <span class="difficulty-badge" [class]="'badge-' + getDifficultyColor(course.difficulty)">
                {{ getDifficultyLabel(course.difficulty) }}
              </span>
            </div>
            <div class="meta-item" *ngIf="hasLessons">
              <i class="pi pi-play-circle"></i>
              <span>{{ lessons.length }} درس</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ✅ Admin Actions Section -->
    <div *ngIf="isAdminMode" class="admin-actions">
      <div class="actions-bar">
        <button 
          class="btn btn-primary"
          (click)="editCourse()"
        >
          <i class="pi pi-pencil me-2"></i>
          تعديل الكورس
        </button>
        
        <button 
          class="btn btn-outline-success"
          (click)="toggleCourseStatus()"
          [disabled]="isLoading"
        >
          <i class="pi pi-{{ course.status === 'published' ? 'eye-slash' : 'eye' }} me-2"></i>
          {{ course.status === 'published' ? 'إلغاء النشر' : 'نشر الكورس' }}
        </button>
        
        <button 
          class="btn btn-outline-info"
          (click)="viewStudents()"
        >
          <i class="pi pi-users me-2"></i>
          عرض الطلاب
        </button>
      </div>
    </div>

    <!-- ✅ Success Message -->
    <div class="success-container" *ngIf="successMessage">
      <div class="alert alert-success">
        <i class="pi pi-check-circle me-2"></i>
        {{ successMessage }}
      </div>
    </div>

    <!-- ✅ Content Based on Available Data -->
    <div *ngIf="hasLessons" class="course-curriculum-container">
      <!-- Lesson Type Selection -->
      <div class="lesson-type-selection">
        <div class="section-header">
          <h2 class="section-title">
            <i class="pi pi-list me-2"></i>
            اختر نوع الدروس
          </h2>
          <p class="section-description">اختر نوع الدروس التي تريد الوصول إليها</p>
        </div>

        <div class="lesson-type-cards">
          <!-- Center Recorded Card -->
          <div class="lesson-type-card" 
               [class.selected]="selectedLessonType === 'center_recorded'"
               [class.disabled]="!isLessonTypeAvailable('center_recorded')"
               (click)="selectLessonType('center_recorded')">
            
            <div class="card-header">
              <div class="card-icon center-recorded">
                <i class="pi pi-video"></i>
              </div>
              <div class="card-status" *ngIf="selectedLessonType === 'center_recorded'">
                <span class="status-badge selected">محدد</span>
              </div>
            </div>
            
            <div class="card-content">
              <h3 class="card-title">الدروس المسجلة - المركز</h3>
              <p class="card-description">دروس مسجلة في المركز التعليمي بجودة عالية مع شرح تفصيلي</p>
              
              <div class="card-features">
                <span class="feature-item">
                  <i class="pi pi-check"></i>
                  جودة عالية HD
                </span>
                <span class="feature-item">
                  <i class="pi pi-check"></i>
                  شرح تفصيلي
                </span>
                <span class="feature-item">
                  <i class="pi pi-check"></i>
                  إمكانية الإعادة
                </span>
              </div>
            </div>
            
            <div class="card-action">
              <button class="btn" 
                      [class.btn-primary]="selectedLessonType !== 'center_recorded'"
                      [class.btn-success]="selectedLessonType === 'center_recorded'"
                      [disabled]="!isLessonTypeAvailable('center_recorded')">
                <i class="pi pi-play-circle me-2"></i>
                <span *ngIf="selectedLessonType !== 'center_recorded'">اختر</span>
                <span *ngIf="selectedLessonType === 'center_recorded'">محدد</span>
              </button>
            </div>
          </div>

          <!-- Studio Produced Card -->
          <div class="lesson-type-card" 
               [class.selected]="selectedLessonType === 'studio_produced'"
               [class.disabled]="!isLessonTypeAvailable('studio_produced')"
               (click)="selectLessonType('studio_produced')">
            
            <div class="card-header">
              <div class="card-icon studio-produced">
                <i class="pi pi-play-circle"></i>
              </div>
              <div class="card-status" *ngIf="selectedLessonType === 'studio_produced'">
                <span class="status-badge selected">محدد</span>
              </div>
              <div class="popular-badge" *ngIf="isLessonTypeAvailable('studio_produced')">الأكثر شعبية</div>
            </div>
            
            <div class="card-content">
              <h3 class="card-title">الدروس المنتجة - الاستوديو</h3>
              <p class="card-description">دروس منتجة في الاستوديو بجودة احترافية مع مؤثرات بصرية</p>
              
              <div class="card-features">
                <span class="feature-item">
                  <i class="pi pi-check"></i>
                  جودة 4K احترافية
                </span>
                <span class="feature-item">
                  <i class="pi pi-check"></i>
                  مؤثرات بصرية
                </span>
                <span class="feature-item">
                  <i class="pi pi-check"></i>
                  محتوى تفاعلي
                </span>
              </div>
            </div>
            
            <div class="card-action">
              <button class="btn" 
                      [class.btn-primary]="selectedLessonType !== 'studio_produced'"
                      [class.btn-success]="selectedLessonType === 'studio_produced'"
                      [disabled]="!isLessonTypeAvailable('studio_produced')">
                <i class="pi pi-star me-2"></i>
                <span *ngIf="selectedLessonType !== 'studio_produced'">اختر</span>
                <span *ngIf="selectedLessonType === 'studio_produced'">محدد</span>
              </button>
            </div>
          </div>

          <!-- Live Zoom Card (Disabled) -->
          <div class="lesson-type-card disabled">
            <div class="card-header">
              <div class="card-icon zoom-meeting">
                <i class="pi pi-users"></i>
              </div>
              <div class="card-status">
                <span class="status-badge disabled">قريباً</span>
              </div>
            </div>
            
            <div class="card-content">
              <h3 class="card-title">الجلسات المباشرة - Zoom</h3>
              <p class="card-description">جلسات تفاعلية مباشرة عبر Zoom مع إمكانية الأسئلة والمناقشة</p>
              
              <div class="card-features">
                <span class="feature-item disabled">
                  <i class="pi pi-times"></i>
                  تفاعل مباشر
                </span>
                <span class="feature-item disabled">
                  <i class="pi pi-times"></i>
                  أسئلة وأجوبة
                </span>
                <span class="feature-item disabled">
                  <i class="pi pi-times"></i>
                  جلسات جماعية
                </span>
              </div>
            </div>
            
            <div class="card-action">
              <button class="btn btn-secondary" disabled>
                <i class="pi pi-lock me-2"></i>
                غير متاح
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ✅ Course Units and Lessons (when lesson type is selected) -->
      <div class="course-curriculum" *ngIf="selectedLessonType">
        <div class="curriculum-header">
          <h2 class="curriculum-title">
            <i class="pi pi-play-circle me-2"></i>
            {{ getSelectedLessonTypeInfo()?.title }}
          </h2>
          <div class="curriculum-stats">
            <span class="stat-item">
              <i class="pi pi-play-circle"></i>
              {{ getTotalLessons() }} درس
            </span>
            <span class="stat-item">
              <i class="pi pi-clock"></i>
              {{ getTotalDuration() }}
            </span>
          </div>
        </div>

        <!-- ✅ Display Units with Filtered Lessons -->
        <div class="units-container" *ngIf="getFilteredUnits().length > 0">
          <div class="unit-card" *ngFor="let unit of getFilteredUnits(); let unitIndex = index">
            <div class="unit-header">
              <div class="unit-info">
                <h3 class="unit-title">{{ unit.name }}</h3>
                <p class="unit-description" *ngIf="unit.description">{{ unit.description }}</p>
              </div>
              <div class="unit-stats">
                <span class="lessons-count">{{ unit.lessons?.length || 0 }} دروس</span>
              </div>
            </div>
            
            <!-- Lessons List -->
            <div class="lessons-list" *ngIf="unit.lessons && unit.lessons.length > 0">
              <div class="lesson-item" 
                   *ngFor="let lesson of unit.lessons; let lessonIndex = index"
                   [class.locked]="!isAdminMode && !lesson.isFree && !lesson.hasAccess"
                   [class.free]="lesson.isFree"
                   [class.accessible]="isAdminMode || lesson.hasAccess"
                   [class.admin-preview]="isAdminMode">
                
                <div class="lesson-content" (click)="startLesson(lesson)">
                  <div class="lesson-number">
                    <span>{{ lessonIndex + 1 }}</span>
                  </div>
                  
                  <div class="lesson-icon">
                    <i class="pi pi-play-circle" *ngIf="isAdminMode || lesson.isFree || lesson.hasAccess"></i>
                    <i class="pi pi-lock" *ngIf="!isAdminMode && !lesson.isFree && !lesson.hasAccess"></i>
                    <i class="pi pi-credit-card" *ngIf="!isAdminMode && lesson.requiresPayment"></i>
                  </div>
                  
                  <div class="lesson-info">
                    <h4 class="lesson-title">{{ lesson.title }}</h4>
                    <p class="lesson-description" *ngIf="lesson.description">{{ lesson.description }}</p>
                    
                    <div class="lesson-meta">
                      <span class="duration" *ngIf="lesson.duration">
                        <i class="pi pi-clock"></i>
                        {{ formatDuration(lesson.duration) }}
                      </span>
                      <span class="difficulty" 
                            [class]="'difficulty-' + lesson.difficulty"
                            *ngIf="lesson.difficulty">
                        <i class="pi pi-signal"></i>
                        {{ getDifficultyLabel(lesson.difficulty) }}
                      </span>
                      <span class="type">
                        <i class="pi pi-video"></i>
                        {{ lesson.lessonType === 'center_recorded' ? 'مركز' : 'استوديو' }}
                      </span>
                    </div>
                  </div>
                  
                  <div class="lesson-actions">
                    <span class="free-badge" *ngIf="lesson.isFree">مجاني</span>
                    <span class="premium-badge" *ngIf="!lesson.isFree && (isAdminMode || lesson.hasAccess)">مميز</span>
                    <button class="btn btn-sm" 
                            [class.btn-primary]="isAdminMode || lesson.isFree || lesson.hasAccess"
                            [class.btn-warning]="!isAdminMode && lesson.requiresPayment && !lesson.hasAccess"
                            [class.btn-outline-secondary]="!isAdminMode && !lesson.isFree && !lesson.hasAccess && !lesson.requiresPayment">
                      <span *ngIf="isAdminMode">معاينة</span>
                      <span *ngIf="!isAdminMode && (lesson.isFree || lesson.hasAccess)">ابدأ</span>
                      <span *ngIf="!isAdminMode && lesson.requiresPayment && !lesson.hasAccess">اشترك</span>
                      <span *ngIf="!isAdminMode && !lesson.isFree && !lesson.hasAccess && !lesson.requiresPayment">مقفل</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- No Lessons Message -->
        <div class="no-lessons-message" *ngIf="getFilteredUnits().length === 0">
          <div class="no-lessons-content">
            <i class="pi pi-exclamation-triangle"></i>
            <h4>لا توجد دروس متاحة</h4>
            <p>لا توجد دروس من النوع المحدد في هذه الدورة حالياً</p>
          </div>
        </div>
      </div>

      <!-- ✅ Selection Prompt when no lesson type selected -->
      <div class="course-curriculum" *ngIf="!selectedLessonType">
        <div class="curriculum-header">
          <h2 class="curriculum-title">
            <i class="pi pi-list-ul me-2"></i>
            محتوى الدورة
          </h2>
          <div class="curriculum-stats">
            <span class="stat-item">
              <i class="pi pi-play-circle"></i>
              {{ lessons.length }} درس متاح
            </span>
            <span class="stat-item" *ngIf="hasUnits">
              <i class="pi pi-bookmark"></i>
              {{ units.length }} وحدة
            </span>
          </div>
        </div>

        <div class="selection-prompt">
          <div class="prompt-content">
            <i class="pi pi-arrow-up"></i>
            <h3>اختر نوع الدروس للبدء</h3>
            <p>يرجى اختيار نوع الدروس من الأعلى لعرض المحتوى المتاح</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ✅ No Content Available -->
    <div class="no-content-container" *ngIf="!hasLessons && !isLoadingContent">
      <div class="no-content">
        <div class="no-content-icon">
          <i class="pi pi-book"></i>
        </div>
        <h3>لا يوجد محتوى متاح</h3>
        <p>لم يتم إضافة وحدات أو دروس لهذا الكورس بعد</p>
        <button 
          *ngIf="isAdminMode" 
          class="btn btn-primary"
          (click)="editCourse()"
        >
          <i class="pi pi-plus me-2"></i>
          إضافة محتوى
        </button>
      </div>
    </div>

    <!-- ✅ Enrollment CTA (Students Only) -->
    <div class="enrollment-cta" *ngIf="canEnroll && hasLessons">
      <div class="cta-content">
        <h3>هل أنت مستعد للبدء؟</h3>
        <p>اشترك في الدورة للوصول إلى جميع الدروس والمواد التعليمية</p>
        <button class="btn btn-primary btn-lg">
          <i class="pi pi-credit-card me-2"></i>
          سجل في الدورة
        </button>
      </div>
    </div>
  </div>

  <!-- ✅ Payment Plans Modal (unchanged) -->
  <div class="payment-modal-overlay" *ngIf="showPaymentModal" (click)="closePaymentModal()">
    <div class="payment-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="pi pi-credit-card me-2"></i>
          خطط الاشتراك
        </h3>
        <button class="modal-close" (click)="closePaymentModal()">
          <i class="pi pi-times"></i>
        </button>
      </div>

      <div class="modal-content">
        <!-- Loading State -->
        <div class="loading-plans" *ngIf="loadingPaymentPlans">
          <i class="pi pi-spinner pi-spin"></i>
          <p>جاري تحميل خطط الاشتراك...</p>
        </div>

        <!-- Payment Plans -->
        <div class="payment-plans" *ngIf="!loadingPaymentPlans && paymentPlans.length > 0">
          <div class="plan-card" 
               *ngFor="let plan of paymentPlans"
               [class.popular]="plan.isPopular">
            
            <div class="plan-header">
              <div class="plan-badge" *ngIf="plan.isPopular">الأكثر شعبية</div>
              <h4 class="plan-name">{{ plan.name }}</h4>
              <p class="plan-description">{{ plan.description }}</p>
            </div>

            <div class="plan-pricing">
              <div class="price-display">
                <span class="currency">{{ plan.currency }}</span>
                <span class="price">{{ plan.price }}</span>
                <span class="duration">/ {{ getPlanDurationLabel(plan.duration) }}</span>
              </div>
              <div class="discount" *ngIf="plan.discountPercentage !== '0.00'">
                خصم {{ plan.discountPercentage }}%
              </div>
            </div>

            <div class="plan-features">
              <ul>
                <li *ngFor="let feature of plan.features">
                  <i class="pi pi-check"></i>
                  {{ feature }}
                </li>
              </ul>
            </div>

            <div class="plan-action">
              <button class="btn btn-primary btn-block" 
                      (click)="subscribeToPlan(plan)">
                <i class="pi pi-shopping-cart me-2"></i>
                اختر هذه الخطة
              </button>
            </div>
          </div>
        </div>

        <!-- No Plans Message -->
        <div class="no-plans-message" *ngIf="!loadingPaymentPlans && paymentPlans.length === 0">
          <div class="no-plans-content">
            <i class="pi pi-exclamation-triangle"></i>
            <h4>لا توجد خطط متاحة</h4>
            <p>لا توجد خطط اشتراك متاحة حالياً لهذا النوع من الدروس</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>